<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modulr Node Dashboard</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#fafafa;--fg:#0a0a0a;
  --panel:#ffffff;--panel-border:rgba(0,0,0,0.08);
  --muted:rgba(10,10,10,0.50);
  --accent:#4f63d2;--accent-light:rgba(79,99,210,0.07);
  --success:#16a34a;--success-bg:rgba(22,163,74,0.07);
  --warning:#c2850c;--warning-bg:rgba(194,133,12,0.07);
  --danger:#dc2626;--danger-bg:rgba(220,38,38,0.07);
  --sidebar-w:260px;--topbar-h:52px;
  --radius:14px;--radius-sm:10px;
  --font-sans:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  --font-mono:"SF Mono",SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
}
html,body{background:var(--bg);color:var(--fg);min-height:100dvh;font-size:13px;line-height:1.55;font-family:var(--font-sans)}
a{color:inherit;text-decoration:none}
button{font:inherit;border:none;background:none;cursor:pointer}

.topbar{
  position:fixed;top:0;left:0;right:0;height:var(--topbar-h);z-index:30;
  display:flex;align-items:center;gap:14px;padding:0 20px;
  border-bottom:1px solid var(--panel-border);
  background:rgba(255,255,255,0.92);backdrop-filter:blur(14px);
}
.topbar-logo{font-weight:700;font-size:14px;letter-spacing:-.02em;display:flex;align-items:center;gap:7px;color:var(--fg)}
.topbar-logo svg{width:20px;height:20px;color:var(--accent)}
.topbar-badge{font-size:9px;font-weight:700;letter-spacing:.1em;padding:2px 7px;border-radius:5px;background:var(--accent-light);color:var(--accent)}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:14px}
.topbar-meta{font-size:11px;color:var(--muted);white-space:nowrap}
.topbar-refresh{
  font-size:11px;font-weight:600;color:var(--accent);
  padding:5px 12px;border-radius:7px;border:1px solid var(--panel-border);
  transition:background .12s;
}
.topbar-refresh:hover{background:var(--accent-light)}

.sidebar{
  position:fixed;left:0;top:var(--topbar-h);z-index:20;
  width:var(--sidebar-w);height:calc(100dvh - var(--topbar-h));
  overflow-y:auto;border-right:1px solid var(--panel-border);
  background:var(--panel);padding:16px 12px;
}
.sidebar-label{font-size:9px;font-weight:700;letter-spacing:.22em;color:var(--muted);padding:0 10px;margin-bottom:6px}
.sidebar-section{margin-bottom:20px}
.sidebar-nav{display:grid;gap:2px}
.sidebar-item{
  display:flex;align-items:center;gap:10px;
  padding:8px 10px;border-radius:var(--radius-sm);
  border:1px solid transparent;transition:all .12s;
  font-size:12px;font-weight:600;color:rgba(10,10,10,0.65);text-align:left;
}
.sidebar-item:hover{background:rgba(0,0,0,0.025);border-color:var(--panel-border)}
.sidebar-item.active{background:rgba(0,0,0,0.04);border-color:var(--panel-border);color:var(--fg)}
.sidebar-item svg{width:15px;height:15px;opacity:.55;flex-shrink:0}
.sidebar-item.active svg{opacity:.8}
.sidebar-item-text{min-width:0;flex:1}
.sidebar-item-desc{font-size:10px;font-weight:400;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.main{margin-left:var(--sidebar-w);padding-top:var(--topbar-h)}
.content{max-width:1320px;margin:0 auto;padding:20px}

.card{
  background:var(--panel);border:1px solid var(--panel-border);
  border-radius:var(--radius);padding:18px 20px;margin-bottom:14px;
  box-shadow:0 1px 3px rgba(0,0,0,0.03);
}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:12px}
.card-title{font-size:14px;font-weight:700;letter-spacing:-.01em;white-space:nowrap}
.card-badge{font-size:9px;font-weight:700;letter-spacing:.06em;padding:3px 9px;border-radius:5px;white-space:nowrap}
.badge-ok{background:var(--success-bg);color:var(--success)}
.badge-warn{background:var(--warning-bg);color:var(--warning)}
.badge-err{background:var(--danger-bg);color:var(--danger)}
.badge-neutral{background:rgba(0,0,0,0.04);color:var(--muted)}

/* Alert banner */
.alert{padding:10px 14px;border-radius:var(--radius-sm);margin-bottom:14px;font-size:12px;font-weight:500;display:flex;align-items:flex-start;gap:8px}
.alert svg{flex-shrink:0;margin-top:1px}
.alert-warn{background:var(--warning-bg);color:#92610a;border:1px solid rgba(194,133,12,0.15)}
.alert-err{background:var(--danger-bg);color:#991b1b;border:1px solid rgba(220,38,38,0.12)}
.alert-info{background:var(--accent-light);color:var(--accent);border:1px solid rgba(79,99,210,0.12)}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:14px}
.stat-box{
  padding:12px 14px;border-radius:var(--radius-sm);
  border:1px solid var(--panel-border);overflow:hidden;
  background:var(--bg);
}
.stat-label{font-size:9px;font-weight:700;letter-spacing:.14em;color:var(--muted);margin-bottom:3px;text-transform:uppercase;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stat-value{font-size:17px;font-weight:700;letter-spacing:-.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stat-value.mono{font-family:var(--font-mono);font-size:12px;letter-spacing:0}
.stat-value.sm{font-size:13px}

.table-wrap{overflow-x:auto;margin-bottom:6px}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{
  text-align:left;font-size:9px;font-weight:700;letter-spacing:.12em;
  color:var(--muted);text-transform:uppercase;
  padding:7px 10px;border-bottom:1px solid var(--panel-border);white-space:nowrap;
}
tbody td{padding:8px 10px;border-bottom:1px solid rgba(0,0,0,0.03);vertical-align:middle}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover{background:rgba(0,0,0,0.015)}

.mono{font-family:var(--font-mono);font-size:11px}
.truncate{max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:bottom}
.text-muted{color:var(--muted)}
.text-success{color:var(--success)}
.text-warning{color:var(--warning)}
.text-danger{color:var(--danger)}
.text-accent{color:var(--accent)}
.fw600{font-weight:600}

/* Timeline */
.timeline{display:flex;flex-direction:column;gap:6px}
.timeline-item{
  display:flex;align-items:flex-start;gap:10px;
  padding:10px 14px;border-radius:var(--radius-sm);
  border:1px solid var(--panel-border);background:var(--bg);
  transition:background .1s;
}
.timeline-item:hover{background:rgba(0,0,0,0.015)}
.timeline-idx{
  width:26px;height:26px;border-radius:7px;
  display:grid;place-items:center;font-weight:700;font-size:11px;flex-shrink:0;
}
.timeline-idx.done{background:var(--success-bg);color:var(--success)}
.timeline-idx.active{background:var(--accent-light);color:var(--accent)}
.timeline-idx.pending{background:rgba(0,0,0,0.04);color:var(--muted)}
.timeline-body{flex:1;min-width:0}
.timeline-title{font-weight:600;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.timeline-meta{font-size:10.5px;color:var(--muted);margin-top:2px;line-height:1.6}
.timeline-meta .mono{font-size:10.5px}

/* Leader cards */
.leader-card{
  border:1px solid var(--panel-border);border-radius:var(--radius-sm);
  background:var(--bg);margin-bottom:8px;overflow:hidden;
}
.leader-card-head{
  display:flex;align-items:center;gap:10px;padding:12px 16px;
  border-bottom:1px solid var(--panel-border);
}
.leader-card-idx{
  width:30px;height:30px;border-radius:8px;
  display:grid;place-items:center;font-weight:700;font-size:12px;flex-shrink:0;
}
.leader-card-idx.done{background:var(--success-bg);color:var(--success)}
.leader-card-idx.active{background:var(--accent-light);color:var(--accent)}
.leader-card-idx.pending{background:rgba(0,0,0,0.04);color:var(--muted)}
.leader-card-pk{flex:1;min-width:0;font-weight:600;font-size:12px}
.leader-card-pk .mono{font-size:11.5px}
.leader-card-status{flex-shrink:0}
.leader-card-status-pill{
  display:inline-flex;align-items:center;gap:5px;
  font-size:10px;font-weight:700;letter-spacing:.04em;
  padding:4px 10px;border-radius:6px;
}
.pill-included{background:var(--success-bg);color:var(--success)}
.pill-confirmed{background:var(--success-bg);color:#15803d}
.pill-collected{background:var(--accent-light);color:var(--accent)}
.pill-collecting{background:var(--warning-bg);color:var(--warning)}
.pill-pending{background:rgba(0,0,0,0.04);color:var(--muted)}

.leader-card-body{padding:10px 16px;display:grid;grid-template-columns:1fr 1fr;gap:6px 20px}
.leader-card-body.cols3{grid-template-columns:1fr 1fr 1fr}
.leader-detail{display:flex;align-items:baseline;gap:6px;font-size:11.5px;padding:4px 0}
.leader-detail-label{color:var(--muted);font-weight:600;font-size:10px;letter-spacing:.06em;white-space:nowrap;min-width:80px}
.leader-detail-value{font-weight:500}
.leader-detail-value .mono{font-size:11px}

.leader-card-explain{
  padding:8px 16px;border-top:1px solid var(--panel-border);
  font-size:11px;color:var(--muted);line-height:1.5;
}

/* slider nav */
.slider-nav{display:flex;align-items:center;gap:8px}
.slider-btn{
  width:28px;height:28px;border-radius:7px;
  border:1px solid var(--panel-border);background:var(--bg);
  display:grid;place-items:center;font-size:13px;font-weight:600;
  cursor:pointer;transition:all .12s;color:var(--fg);
}
.slider-btn:hover{background:rgba(0,0,0,0.04);border-color:rgba(0,0,0,0.15)}
.slider-btn:disabled{opacity:.3;cursor:default;background:var(--bg)}
.slider-label{font-size:12px;font-weight:700;min-width:100px;text-align:center}

/* progress mini bar */
.mini-progress{display:inline-flex;align-items:center;gap:6px}
.mini-progress-bar{width:60px;height:5px;border-radius:3px;background:rgba(0,0,0,0.06);overflow:hidden;display:inline-block}
.mini-progress-fill{height:100%;border-radius:3px;display:block}

.hidden{display:none!important}

@media(max-width:860px){
  :root{--sidebar-w:0px}
  .sidebar{display:none}
}
</style>
</head>
<body>

<header class="topbar">
  <div class="topbar-logo">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
    Modulr Dashboard
  </div>
  <span class="topbar-badge">NODE</span>
  <div class="topbar-right">
    <span class="topbar-meta" id="uptime"></span>
    <span class="topbar-meta" id="refresh-timer"></span>
    <button class="topbar-refresh" onclick="fetchAll()">Refresh</button>
  </div>
</header>

<aside class="sidebar">
  <div class="sidebar-section">
    <div class="sidebar-label">OVERVIEW</div>
    <nav class="sidebar-nav">
      <button class="sidebar-item active" data-page="overview">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
        <div class="sidebar-item-text">
          <div>Overview</div>
          <div class="sidebar-item-desc">Node status &amp; stats</div>
        </div>
      </button>
    </nav>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-label">THREADS</div>
    <nav class="sidebar-nav">
      <button class="sidebar-item" data-page="execution">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <div class="sidebar-item-text"><div>Execution Thread</div><div class="sidebar-item-desc">Block execution &amp; state</div></div>
      </button>
      <button class="sidebar-item" data-page="approvement">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <div class="sidebar-item-text"><div>Approvement Thread</div><div class="sidebar-item-desc">Epoch rotation &amp; consensus</div></div>
      </button>
      <button class="sidebar-item" data-page="leader_finalization">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        <div class="sidebar-item-text"><div>Leader Finalization</div><div class="sidebar-item-desc">ALFP collection &amp; delivery</div></div>
      </button>
    </nav>
  </div>
</aside>

<div class="main">
  <div class="content">

    <div id="page-overview">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Node Overview</div>
          <span class="card-badge badge-neutral" id="overview-version"></span>
        </div>
        <div id="overview-alert"></div>
        <div class="stats-grid" id="overview-stats"></div>
        <div id="overview-anchors"></div>
      </div>
    </div>

    <div id="page-execution" class="hidden">
      <div class="card">
        <div class="card-header"><div class="card-title">Epoch Data</div><span class="card-badge badge-neutral" id="exec-epoch-badge"></span></div>
        <div class="stats-grid" id="exec-stats"></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Statistics</div></div>
        <div class="stats-grid" id="exec-epoch-stats"></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Execution Data (per Leader)</div></div>
        <div class="table-wrap" id="exec-data-table"></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Sequence Alignment</div></div>
        <div class="stats-grid" id="exec-alignment"></div>
        <div class="table-wrap" id="exec-alignment-leaders"></div>
      </div>
    </div>

    <div id="page-approvement" class="hidden">
      <div class="card">
        <div class="card-header"><div class="card-title">Approvement Thread</div><span class="card-badge badge-neutral" id="approve-epoch-badge"></span></div>
        <div class="stats-grid" id="approve-stats"></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Leaders Sequence</div></div>
        <div class="table-wrap" id="approve-leaders-table"></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title" id="approve-quorum-header">Quorum Members</div></div>
        <div class="table-wrap" id="approve-quorum-table"></div>
      </div>
    </div>

    <div id="page-leader_finalization" class="hidden">
      <div class="card">
        <div class="card-header"><div class="card-title">Leader Finalization Thread</div><span class="card-badge badge-neutral" id="alfp-epoch-badge"></span></div>
        <div id="alfp-alert"></div>
        <div class="stats-grid" id="alfp-stats"></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Leaders ALFP Status</div></div>
        <div id="alfp-leaders"></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Recent Epochs History</div>
          <div class="slider-nav">
            <button class="slider-btn" id="hist-prev" title="Previous epoch">&larr;</button>
            <span class="slider-label" id="hist-label"></span>
            <button class="slider-btn" id="hist-next" title="Next epoch">&rarr;</button>
          </div>
        </div>
        <div id="alfp-history"></div>
      </div>
    </div>


  </div>
</div>

<script>
const REFRESH_INTERVAL = 3000;
let currentPage = 'overview';
let lastFetch = Date.now();
let dataCache = {};

document.querySelectorAll('.sidebar-item[data-page]').forEach(btn => {
  btn.addEventListener('click', () => {
    currentPage = btn.dataset.page;
    document.querySelectorAll('.sidebar-item[data-page]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
    document.getElementById('page-' + currentPage).classList.remove('hidden');
    renderCurrent();
  });
});

function shortKey(key, n) {
  n = n || 8;
  if (!key) return '\u2014';
  if (key.length <= n * 2 + 3) return key;
  return key.slice(0, n) + '\u2026' + key.slice(-n);
}
function shortHash(h, n) {
  n = n || 8;
  if (!h) return '\u2014';
  if (h.length <= n + 1) return h;
  return h.slice(0, n) + '\u2026';
}
function fmtNum(n) {
  if (n === undefined || n === null) return '\u2014';
  return Number(n).toLocaleString();
}

function statBox(label, value, cls) {
  cls = cls || '';
  var escaped = typeof value === 'string' ? value : String(value);
  return '<div class="stat-box"><div class="stat-label">' + label + '</div><div class="stat-value ' + cls + '">' + escaped + '</div></div>';
}

function monoVal(full, display) {
  return '<span class="mono truncate" title="' + full + '">' + display + '</span>';
}

function alertBox(type, msg) {
  var iconMap = {
    warn: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    err: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    info: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
  };
  return '<div class="alert alert-' + type + '">' + (iconMap[type] || '') + '<div>' + msg + '</div></div>';
}

function getETEpoch() {
  var et = dataCache.execution;
  return et ? et.epoch.id : null;
}
function getATEpoch() {
  var at = dataCache.approvement;
  return at ? at.epoch.id : null;
}

// ── OVERVIEW ──
function renderOverview() {
  var d = dataCache.overview;
  if (!d) return;
  document.getElementById('overview-version').textContent = 'v' + d.coreVersion;
  document.getElementById('uptime').textContent = 'Uptime: ' + d.uptime;

  var et = dataCache.execution;
  var at = dataCache.approvement;
  var alfp = dataCache.leader_finalization;

  var html = '';
  html += statBox('Public Key', monoVal(d.publicKey, shortKey(d.publicKey, 10)));
  html += statBox('Network ID', monoVal(d.networkId, shortKey(d.networkId, 10)));
  html += statBox('Core Version', d.coreVersion);
  html += statBox('Uptime', d.uptime);
  if (et) {
    html += statBox('ET Epoch', et.epoch.id);
    html += statBox('Last Height', fmtNum(et.statistics ? et.statistics.lastHeight : null));
    html += statBox('Total TXs', fmtNum(et.statistics ? et.statistics.totalTransactions : null));
    html += statBox('Successful TXs', fmtNum(et.statistics ? et.statistics.successfulTransactions : null));
  }
  if (at) {
    html += statBox('AT Epoch', at.epoch.id);
    html += statBox('Current Leader', at.epoch.currentLeaderIndex);
  }
  if (alfp) {
    html += statBox('ALFP Epoch', alfp.processingEpochId);
  }
  document.getElementById('overview-stats').innerHTML = html;

  // Epoch mismatch alert
  var alerts = '';
  if (et && alfp && alfp.processingEpochId > et.epoch.id) {
    alerts += alertBox('warn', 'ALFP progress (epoch ' + alfp.processingEpochId + ') is ahead of Execution Thread (epoch ' + et.epoch.id + '). The finalization thread may be processing stale data from a previous run.');
  }
  document.getElementById('overview-alert').innerHTML = alerts;

  if (d.anchors && d.anchors.length > 0) {
    var ah = '<div style="margin-top:4px"><div class="stat-label" style="margin-bottom:6px">ANCHORS (' + d.anchors.length + ')</div>';
    ah += '<table><thead><tr><th>#</th><th>Pubkey</th><th>URL</th></tr></thead><tbody>';
    d.anchors.forEach(function(a, i) {
      ah += '<tr><td>' + i + '</td><td class="mono"><span class="truncate" title="' + a.pubkey + '">' + shortKey(a.pubkey) + '</span></td><td class="mono text-muted">' + (a.anchorURL || '\u2014') + '</td></tr>';
    });
    ah += '</tbody></table></div>';
    document.getElementById('overview-anchors').innerHTML = ah;
  }
}

// ── EXECUTION ──
function renderExecution() {
  var d = dataCache.execution;
  if (!d) return;
  document.getElementById('exec-epoch-badge').textContent = 'Epoch #' + d.epoch.id;

  var html = '';
  html += statBox('Epoch ID', d.epoch.id);
  html += statBox('Epoch Hash', monoVal(d.epoch.hash, shortHash(d.epoch.hash)), 'mono');
  html += statBox('Start Timestamp', d.epoch.startTimestamp);
  html += statBox('Current Leader', d.epoch.currentLeaderIndex);
  html += statBox('Leaders', d.epoch.leadersSequence ? d.epoch.leadersSequence.length : 0);
  html += statBox('Quorum Size', d.epoch.quorum ? d.epoch.quorum.length : 0);
  document.getElementById('exec-stats').innerHTML = html;

  var s = d.statistics || {};
  var es = d.epochStatistics || {};
  var shtml = '';
  shtml += statBox('Last Height', fmtNum(s.lastHeight));
  shtml += statBox('Blocks Generated', fmtNum(s.blocksGenerated));
  shtml += statBox('Total TXs', fmtNum(s.totalTransactions));
  shtml += statBox('Successful TXs', fmtNum(s.successfulTransactions));
  shtml += statBox('Total Fees', fmtNum(s.totalFees));
  shtml += statBox('Accounts', fmtNum(s.accountsNumber));
  shtml += statBox('Staking Delta', fmtNum(s.stakingDelta));
  shtml += statBox('Epoch Blocks', fmtNum(es.blocksGenerated));
  shtml += statBox('Epoch TXs', fmtNum(es.totalTransactions));
  shtml += statBox('Epoch Fees', fmtNum(es.totalFees));
  document.getElementById('exec-epoch-stats').innerHTML = shtml;

  var execData = d.executionData || {};
  var leaders = d.epoch.leadersSequence || [];
  var t = '<table><thead><tr><th>#</th><th>Leader</th><th>Index</th><th>Hash</th></tr></thead><tbody>';
  leaders.forEach(function(l, i) {
    var ed = execData[l] || {};
    t += '<tr><td>' + i + '</td><td class="mono"><span class="truncate" title="' + l + '">' + shortKey(l) + '</span></td><td>' + (ed.Index !== undefined ? ed.Index : '\u2014') + '</td><td class="mono">' + shortHash(ed.Hash) + '</td></tr>';
  });
  t += '</tbody></table>';
  document.getElementById('exec-data-table').innerHTML = t;

  var sa = d.sequenceAlignment || {};
  var ahtml = '';
  ahtml += statBox('Current Anchor', sa.currentAnchorAssumption);
  ahtml += statBox('Anchor Block Observed', sa.currentAnchorBlockIndexObserved);
  ahtml += statBox('Leader To Execute From', sa.currentToExecute);
  document.getElementById('exec-alignment').innerHTML = ahtml;

  var lbl = sa.lastBlocksByLeaders || {};
  var al = '<table><thead><tr><th>Leader</th><th>Last Index</th><th>Last Hash</th></tr></thead><tbody>';
  var lblKeys = Object.keys(lbl);
  if (lblKeys.length === 0) {
    al += '<tr><td colspan="3" class="text-muted">No alignment data yet</td></tr>';
  } else {
    lblKeys.forEach(function(leader) {
      var stats = lbl[leader];
      al += '<tr><td class="mono"><span class="truncate" title="' + leader + '">' + shortKey(leader) + '</span></td><td>' + stats.Index + '</td><td class="mono">' + shortHash(stats.Hash) + '</td></tr>';
    });
  }
  al += '</tbody></table>';
  document.getElementById('exec-alignment-leaders').innerHTML = al;
}

// ── APPROVEMENT ──
function renderApprovement() {
  var d = dataCache.approvement;
  if (!d) return;
  document.getElementById('approve-epoch-badge').textContent = 'Epoch ' + d.epoch.id;

  var np = d.networkParameters || {};
  var html = '';
  html += statBox('Epoch ID', d.epoch.id);
  html += statBox('Epoch Hash', monoVal(d.epoch.hash, shortHash(d.epoch.hash)), 'mono');
  html += statBox('Start Timestamp', d.epoch.startTimestamp);
  html += statBox('Current Leader', d.epoch.currentLeaderIndex);
  html += statBox('Core Version', d.coreVersion);
  html += statBox('Quorum Size', np.QUORUM_SIZE);
  html += statBox('Epoch Duration', np.EPOCH_DURATION ? (np.EPOCH_DURATION / 1000) + 's' : '\u2014');
  html += statBox('Leadership Duration', np.LEADERSHIP_DURATION ? (np.LEADERSHIP_DURATION / 1000) + 's' : '\u2014');
  html += statBox('Block Time', np.BLOCK_TIME ? np.BLOCK_TIME + 'ms' : '\u2014');
  html += statBox('TX Limit / Block', np.TXS_LIMIT_PER_BLOCK);
  document.getElementById('approve-stats').innerHTML = html;

  var leaders = d.epoch.leadersSequence || [];
  var lh = '<table><thead><tr><th>#</th><th>Leader Pubkey</th><th>Status</th></tr></thead><tbody>';
  leaders.forEach(function(l, i) {
    var isCurrent = i === d.epoch.currentLeaderIndex;
    var st;
    if (isCurrent) {
      st = '<span class="leader-card-status-pill pill-collected">ACTIVE</span>';
    } else if (i < d.epoch.currentLeaderIndex) {
      st = '<span class="leader-card-status-pill pill-included">DONE</span>';
    } else {
      st = '<span class="leader-card-status-pill pill-pending">PENDING</span>';
    }
    lh += '<tr><td>' + i + '</td><td class="mono"><span class="truncate" title="' + l + '">' + shortKey(l) + '</span></td><td>' + st + '</td></tr>';
  });
  lh += '</tbody></table>';
  document.getElementById('approve-leaders-table').innerHTML = lh;

  var quorum = d.epoch.quorum || [];
  var qMajority = Math.floor(quorum.length * 2 / 3) + 1;
  document.getElementById('approve-quorum-header').innerHTML = 'Quorum Members <span class="text-muted" style="font-size:11px;font-weight:400">(' + quorum.length + ' members, majority: ' + qMajority + ')</span>';
  var qh = '<table><thead><tr><th>#</th><th>Quorum Member Pubkey</th></tr></thead><tbody>';
  quorum.forEach(function(q, i) {
    qh += '<tr><td>' + i + '</td><td class="mono"><span class="truncate" title="' + q + '">' + shortKey(q) + '</span></td></tr>';
  });
  qh += '</tbody></table>';
  document.getElementById('approve-quorum-table').innerHTML = qh;
}

// ── LEADER FINALIZATION ──
var historyEpochIdx = 0;

function renderLeaderFinalization() {
  var d = dataCache.leader_finalization;
  if (!d) return;

  document.getElementById('alfp-epoch-badge').textContent = 'ALFP Epoch #' + d.processingEpochId;

  var etEpoch = getETEpoch();
  var alerts = '';
  if (etEpoch !== null && d.processingEpochId > etEpoch) {
    alerts += alertBox('warn', 'ALFP progress is at epoch <b>' + d.processingEpochId + '</b> but ET is at epoch <b>' + etEpoch + '</b>. The finalization thread is working with data from a previous network state.');
  }
  if (!d.inQuorum && d.leaders && d.leaders.length > 0) {
    alerts += alertBox('info', 'This node is <b>not in quorum</b> for the current ALFP epoch. It will skip finalization and advance.');
  }
  document.getElementById('alfp-alert').innerHTML = alerts;

  var leaders = d.leaders || [];
  var done = leaders.filter(function(l) { return l.included || l.confirmedByAlignment; }).length;
  var alfpReady = leaders.filter(function(l) { return l.hasAlfp && !l.included && !l.confirmedByAlignment; }).length;
  var collecting = leaders.filter(function(l) { return !l.hasAlfp && !l.included && !l.confirmedByAlignment && l.proofsCollected > 0; }).length;
  var pendingCount = leaders.filter(function(l) { return !l.hasAlfp && !l.included && !l.confirmedByAlignment && l.proofsCollected === 0; }).length;
  var globalMaj = d.wsConnectionCount > 0 ? Math.floor(d.wsConnectionCount * 2 / 3) + 1 : 0;

  var html = '';
  html += statBox('ALFP Processing Epoch', d.processingEpochId);
  html += statBox('ET Epoch', etEpoch !== null ? etEpoch : '\u2014');
  html += statBox('In Quorum', d.inQuorum ? '<span class="text-success">\u2713 Yes</span>' : '<span class="text-warning">\u2717 No</span>');
  html += statBox('WS Connections', d.wsConnectionCount + (globalMaj > 0 ? ' <span class="text-muted" style="font-size:11px">(majority: ' + globalMaj + ')</span>' : ''));

  var progressColor = done === leaders.length && leaders.length > 0 ? 'var(--success)' : 'var(--accent)';
  var progressPct = leaders.length > 0 ? Math.round(done / leaders.length * 100) : 0;
  html += statBox('Progress',
    '<div><b>' + done + '</b> / ' + leaders.length + ' finalized' +
    '<div style="margin-top:4px;display:flex;gap:6px;flex-wrap:wrap;font-size:10px;color:var(--muted)">' +
      '<span>\u2713 Done: ' + done + '</span>' +
      '<span>\u25CF ALFP ready: ' + alfpReady + '</span>' +
      '<span>\u25CB Collecting: ' + collecting + '</span>' +
      '<span>\u2022 Pending: ' + pendingCount + '</span>' +
    '</div>' +
    '<div style="margin-top:6px;height:5px;border-radius:3px;background:rgba(0,0,0,0.06);overflow:hidden">' +
      '<div style="width:' + progressPct + '%;height:100%;border-radius:3px;background:' + progressColor + ';transition:width .3s"></div>' +
    '</div></div>'
  );
  document.getElementById('alfp-stats').innerHTML = html;

  // Current epoch leader cards
  var majority = d.wsConnectionCount > 0 ? Math.floor(d.wsConnectionCount * 2 / 3) + 1 : 0;
  var th = '';
  leaders.forEach(function(l) {
    th += buildLeaderCard(l, majority, false);
  });
  if (leaders.length === 0) {
    th = '<div class="text-muted" style="padding:14px">No leaders data available for this epoch</div>';
  }
  document.getElementById('alfp-leaders').innerHTML = th;

  // History slider
  var recent = d.recentEpochs || [];
  if (recent.length === 0) {
    document.getElementById('hist-label').textContent = 'No history';
    document.getElementById('hist-prev').disabled = true;
    document.getElementById('hist-next').disabled = true;
    document.getElementById('alfp-history').innerHTML = '<div class="text-muted" style="padding:14px">No previous epoch data available yet</div>';
    return;
  }

  if (historyEpochIdx >= recent.length) historyEpochIdx = recent.length - 1;
  if (historyEpochIdx < 0) historyEpochIdx = 0;

  var ep = recent[historyEpochIdx];
  var statusPill = ep.allResolved
    ? '<span class="leader-card-status-pill pill-included" style="margin-left:8px">\u2713 ALL FINALIZED</span>'
    : '<span class="leader-card-status-pill pill-collecting" style="margin-left:8px">IN PROGRESS</span>';
  document.getElementById('hist-label').innerHTML = 'Epoch #' + ep.epochId + statusPill + ' <span class="text-muted" style="font-size:10px;margin-left:4px">(' + (historyEpochIdx + 1) + '/' + recent.length + ')</span>';

  document.getElementById('hist-prev').disabled = (historyEpochIdx >= recent.length - 1);
  document.getElementById('hist-next').disabled = (historyEpochIdx <= 0);

  var hc = '';
  (ep.leaders || []).forEach(function(l, idx) {
    var card = {
      pubkey: l.pubkey,
      leaderIndex: idx,
      hasAlfp: l.hasAlfp,
      included: l.included,
      confirmedByAlignment: l.confirmedByAlignment,
      skipDataIndex: '\u2014',
      skipDataHash: '',
      proofsCollected: 0
    };
    hc += buildLeaderCard(card, 0, true);
  });
  if (!ep.leaders || ep.leaders.length === 0) {
    hc = '<div class="text-muted" style="padding:14px">No leaders data for this epoch</div>';
  }
  document.getElementById('alfp-history').innerHTML = hc;
}

document.getElementById('hist-prev').addEventListener('click', function() {
  historyEpochIdx++;
  renderLeaderFinalization();
});
document.getElementById('hist-next').addEventListener('click', function() {
  historyEpochIdx--;
  renderLeaderFinalization();
});

function buildLeaderCard(l, majority, isHistory) {
  var state, pillClass, pillText, explain;

  if (l.included) {
    state = 'done'; pillClass = 'pill-included'; pillText = '\u2713 INCLUDED';
    explain = 'Aggregated ALFP was found inside an accepted anchor block. Finalization for this leader is fully complete.';
  } else if (l.confirmedByAlignment) {
    state = 'done'; pillClass = 'pill-confirmed'; pillText = '\u2713 CONFIRMED';
    explain = isHistory
      ? 'This leader was finalized via sequence alignment. The Execution Thread already had all data for this leader when the epoch completed.'
      : 'Execution Thread already knows the last block for this leader via sequence alignment. No need to wait for anchor inclusion.';
  } else if (l.hasAlfp) {
    state = 'active'; pillClass = 'pill-collected'; pillText = 'ALFP COLLECTED';
    explain = 'Aggregated ALFP proof has been assembled and persisted. Now broadcasting to anchors and waiting for it to appear in an anchor block.';
  } else if (!isHistory && l.proofsCollected > 0) {
    state = 'active'; pillClass = 'pill-collecting'; pillText = 'COLLECTING';
    explain = 'Requesting leader finalization proofs from quorum members. Need ' + majority + '+ signatures to assemble the aggregated proof.';
  } else {
    state = 'pending'; pillClass = 'pill-pending'; pillText = 'PENDING';
    explain = isHistory ? 'No finalization data recorded for this leader.' : 'Waiting for this leader\'s time slot to expire before ALFP collection can begin.';
  }

  var proofsPct = majority > 0 ? Math.min(100, Math.round(l.proofsCollected / majority * 100)) : 0;
  var proofColor = l.hasAlfp || l.included || l.confirmedByAlignment ? 'var(--success)' : (proofsPct >= 100 ? 'var(--success)' : 'var(--accent)');

  var c = '<div class="leader-card">';
  c += '<div class="leader-card-head">';
  c += '<div class="leader-card-idx ' + state + '">' + l.leaderIndex + '</div>';
  c += '<div class="leader-card-pk">' + monoVal(l.pubkey, l.pubkey) + '</div>';
  c += '<div class="leader-card-status"><span class="leader-card-status-pill ' + pillClass + '">' + pillText + '</span></div>';
  c += '</div>';

  c += '<div class="leader-card-body cols3">';

  c += '<div class="leader-detail"><span class="leader-detail-label">ALFP Collected</span><span class="leader-detail-value">' +
    (l.hasAlfp ? '<span class="text-success fw600">\u2713 Yes</span>' : '<span class="text-muted">\u2717 No</span>') + '</span></div>';

  var inclVal;
  if (l.included) {
    inclVal = '<span class="text-success fw600">\u2713 In anchor block</span>';
  } else if (l.confirmedByAlignment) {
    inclVal = '<span class="text-muted">\u2014 Not needed (via alignment)</span>';
  } else {
    inclVal = '<span class="text-muted">\u2717 Not yet</span>';
  }
  c += '<div class="leader-detail"><span class="leader-detail-label">Included</span><span class="leader-detail-value">' + inclVal + '</span></div>';

  c += '<div class="leader-detail"><span class="leader-detail-label">Alignment</span><span class="leader-detail-value">' +
    (l.confirmedByAlignment ? '<span class="text-success fw600">\u2713 Confirmed by ET</span>' : '<span class="text-muted">\u2717 Not confirmed</span>') + '</span></div>';

  if (!isHistory) {
    c += '<div class="leader-detail"><span class="leader-detail-label">Last Block Idx</span><span class="leader-detail-value mono">' +
      l.skipDataIndex + '</span></div>';

    c += '<div class="leader-detail"><span class="leader-detail-label">Last Block Hash</span><span class="leader-detail-value">' +
      monoVal(l.skipDataHash || '', shortHash(l.skipDataHash, 12)) + '</span></div>';

    c += '<div class="leader-detail"><span class="leader-detail-label">Proofs</span><span class="leader-detail-value">' +
      '<span class="mini-progress"><b>' + l.proofsCollected + '</b>' + (majority > 0 ? ' / ' + majority : '') +
      ' <span class="mini-progress-bar"><span class="mini-progress-fill" style="width:' + proofsPct + '%;background:' + proofColor + '"></span></span></span>' +
      '</span></div>';
  }

  c += '</div>';
  c += '<div class="leader-card-explain">' + explain + '</div>';
  c += '</div>';
  return c;
}


function renderCurrent() {
  switch (currentPage) {
    case 'overview': renderOverview(); break;
    case 'execution': renderExecution(); break;
    case 'approvement': renderApprovement(); break;
    case 'leader_finalization': renderLeaderFinalization(); break;
  }
}


async function fetchEndpoint(name, path) {
  try {
    var res = await fetch(path);
    if (res.ok) dataCache[name] = await res.json();
  } catch (e) {
    console.warn('fetch failed:', path, e);
  }
}

async function fetchAll() {
  await Promise.all([
    fetchEndpoint('overview', '/dashboard/api/overview'),
    fetchEndpoint('execution', '/dashboard/api/execution'),
    fetchEndpoint('approvement', '/dashboard/api/approvement'),
    fetchEndpoint('leader_finalization', '/dashboard/api/leader_finalization'),
  ]);
  lastFetch = Date.now();
  renderCurrent();
}

setInterval(function() {
  var ago = Math.round((Date.now() - lastFetch) / 1000);
  document.getElementById('refresh-timer').textContent = 'Updated ' + ago + 's ago';
}, 500);

setInterval(fetchAll, REFRESH_INTERVAL);
fetchAll();
</script>
</body>
</html>
